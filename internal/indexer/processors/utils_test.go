package processors

import (
	"testing"
	"time"

	"github.com/stellar/go/ingest"
	"github.com/stellar/go/network"
	"github.com/stellar/go/toid"
	"github.com/stellar/go/xdr"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"

	"github.com/stellar/wallet-backend/internal/indexer/types"
)

const (
	ledgerCloseMetaXDR = "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"
	envelopeXDRStr     = "AAAABQAAAAAtXnGH1I2eW6PPNwZ9WyiVwdAJxsqqWSHgL2gRotHPFgAAAAAAUST2AAAAAgAAAABsA/wODnAMLn/2fsgMcYpEIkY1jISeGAQ1dS7bn+ZWRwBRIzYAABLlAAAAAwAAAAEAAAAAAAAAAAAAAABoU1PeAAAAAAAAAAEAAAAAAAAAGAAAAAMAAAAAAAAAAAAAAABsA/wODnAMLn/2fsgMcYpEIkY1jISeGAQ1dS7bn+ZWR8OzPIPTGaCDLZfLCwt0pugzXLNM3G9g9khEw3/CE5P8AAAAAFk8U8dqToCc+K4un2xelX4pLBJWWUEf5WQv3ctdjYSoAAAAAQAAABAAAAABAAAABQAAAA8AAAAHRWQyNTUxOQAAAAANAAAAILHqRszNJ/bOhigNYRoEAxU46DgL2rJCM75GS1/jzJvyAAAAEAAAAAEAAAABAAAAAQAAABAAAAABAAAAAQAAAAEAAAAQAAAAAQAAAAEAAAAPAAAAClBlcnNpc3RlbnQAAAAAAAEAAAAAAAAAAgAAAAAAAAAAAAAAAGwD/A4OcAwuf/Z+yAxxikQiRjWMhJ4YBDV1Ltuf5lZHw7M8g9MZoIMtl8sLC3Sm6DNcs0zcb2D2SETDf8ITk/wAAAAAWTxTx2pOgJz4ri6fbF6VfiksElZZQR/lZC/dy12NhKgAAAABAAAAEAAAAAEAAAAFAAAADwAAAAdFZDI1NTE5AAAAAA0AAAAgsepGzM0n9s6GKA1hGgQDFTjoOAvaskIzvkZLX+PMm/IAAAAQAAAAAQAAAAEAAAABAAAAEAAAAAEAAAABAAAAAQAAABAAAAABAAAAAQAAAA8AAAAKUGVyc2lzdGVudAAAAAAAAAAAAAEAAAAAAAAAAgAAAAYAAAABG5UmhMs1obtXWl/ARyBJTfMmoUEun8+F0YCAV4PkWXYAAAAQAAAAAQAAAAIAAAAPAAAAB0VkMjU1MTkAAAAADQAAACCx6kbMzSf2zoYoDWEaBAMVOOg4C9qyQjO+Rktf48yb8gAAAAAAAAAHWTxTx2pOgJz4ri6fbF6VfiksElZZQR/lZC/dy12NhKgAAAACAAAABgAAAAEblSaEyzWhu1daX8BHIElN8yahQS6fz4XRgIBXg+RZdgAAABAAAAABAAAAAgAAAA8AAAAHRWQyNTUxOQAAAAANAAAAILHqRszNJ/bOhigNYRoEAxU46DgL2rJCM75GS1/jzJvyAAAAAQAAAAYAAAABG5UmhMs1obtXWl/ARyBJTfMmoUEun8+F0YCAV4PkWXYAAAAUAAAAAQBNeYsAAFtYAAABOAAAAAAAUSLSAAAAAZ/mVkcAAABA/Rmb2o/Lkk5HvG4RRbDBsLloUSTAY8z+qeDLaBxkh/n76C7E9rbzO4OjTFVKrNXZ58A5koBITCNWVDm+kryyCgAAAAAAAAABotHPFgAAAEAhnVrrQoArmh4RyFq/PwOKdfmiUL20Pcy2RlO49jci7G2Z7EU12n6rHmTqpzOivIPw8eWr9rhx5hbyG425sU0A"
	unsafeMetaXDRStr   = "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"
	txResultPairXDRStr = "ZOuUrMUO78MjzqgDh/3O78MUZsw6aeuNKzEuC1w8YvAAAAAAAEYgzgAAAAGvrvihtletXSNgzAAesxt2O/00MMuiAnPUn/RL4qIVLgAAAAAARiBqAAAAAAAAAAEAAAAAAAAAGAAAAAAqWM8LTwCLmRwC4kGslynnDaqkRvAPdSBL6P02IT7CRgAAAAAAAAAA"
	opXDRStr           = "AAAAAAAAABgAAAADAAAAAAAAAAAAAAAAbAP8Dg5wDC5/9n7IDHGKRCJGNYyEnhgENXUu25/mVkfDszyD0xmggy2XywsLdKboM1yzTNxvYPZIRMN/whOT/AAAAABZPFPHak6AnPiuLp9sXpV+KSwSVllBH+VkL93LXY2EqAAAAAEAAAAQAAAAAQAAAAUAAAAPAAAAB0VkMjU1MTkAAAAADQAAACCx6kbMzSf2zoYoDWEaBAMVOOg4C9qyQjO+Rktf48yb8gAAABAAAAABAAAAAQAAAAEAAAAQAAAAAQAAAAEAAAABAAAAEAAAAAEAAAABAAAADwAAAApQZXJzaXN0ZW50AAAAAAABAAAAAAAAAAIAAAAAAAAAAAAAAABsA/wODnAMLn/2fsgMcYpEIkY1jISeGAQ1dS7bn+ZWR8OzPIPTGaCDLZfLCwt0pugzXLNM3G9g9khEw3/CE5P8AAAAAFk8U8dqToCc+K4un2xelX4pLBJWWUEf5WQv3ctdjYSoAAAAAQAAABAAAAABAAAABQAAAA8AAAAHRWQyNTUxOQAAAAANAAAAILHqRszNJ/bOhigNYRoEAxU46DgL2rJCM75GS1/jzJvyAAAAEAAAAAEAAAABAAAAAQAAABAAAAABAAAAAQAAAAEAAAAQAAAAAQAAAAEAAAAPAAAAClBlcnNpc3RlbnQAAAAAAAA="
)

func Test_ConvertTransaction(t *testing.T) {
	var lcm xdr.LedgerCloseMeta
	err := xdr.SafeUnmarshalBase64(ledgerCloseMetaXDR, &lcm)
	require.NoError(t, err)

	ledgerTxReader, err := ingest.NewLedgerTransactionReaderFromLedgerCloseMeta(network.TestNetworkPassphrase, lcm)
	require.NoError(t, err)
	ingestTx, err := ledgerTxReader.Read()
	require.NoError(t, err)

	gotDataTx, err := ConvertTransaction(&ingestTx, false, false, network.TestNetworkPassphrase)
	require.NoError(t, err)

	metaXDR := unsafeMetaXDRStr
	envelopeXDR := envelopeXDRStr
	wantDataTx := &types.Transaction{
		Hash:                 "64eb94acc50eefc323cea80387fdceefc31466cc3a69eb8d2b312e0b5c3c62f0",
		ToID:                 20929375637504,
		EnvelopeXDR:          &envelopeXDR,
		ResultXDR:            txResultPairXDRStr,
		MetaXDR:              &metaXDR,
		LedgerNumber:         4873,
		LedgerCreatedAt:      time.Date(2025, time.June, 19, 0, 3, 16, 0, time.UTC),
		InnerTransactionHash: "afaef8a1b657ad5d2360cc001eb31b763bfd3430cba20273d49ff44be2a2152e",
	}
	assert.Equal(t, wantDataTx, gotDataTx)
}

func Test_ConvertTransaction_SkipTxEnvelope(t *testing.T) {
	var lcm xdr.LedgerCloseMeta
	err := xdr.SafeUnmarshalBase64(ledgerCloseMetaXDR, &lcm)
	require.NoError(t, err)

	ledgerTxReader, err := ingest.NewLedgerTransactionReaderFromLedgerCloseMeta(network.TestNetworkPassphrase, lcm)
	require.NoError(t, err)
	ingestTx, err := ledgerTxReader.Read()
	require.NoError(t, err)

	// skipTxEnvelope = true
	gotDataTx, err := ConvertTransaction(&ingestTx, false, true, network.TestNetworkPassphrase)
	require.NoError(t, err)

	metaXDR := unsafeMetaXDRStr
	// envelopeXDR should be nil
	wantDataTx := &types.Transaction{
		Hash:                 "64eb94acc50eefc323cea80387fdceefc31466cc3a69eb8d2b312e0b5c3c62f0",
		ToID:                 20929375637504,
		EnvelopeXDR:          nil,
		ResultXDR:            txResultPairXDRStr,
		MetaXDR:              &metaXDR,
		LedgerNumber:         4873,
		LedgerCreatedAt:      time.Date(2025, time.June, 19, 0, 3, 16, 0, time.UTC),
		InnerTransactionHash: "afaef8a1b657ad5d2360cc001eb31b763bfd3430cba20273d49ff44be2a2152e",
	}
	assert.Equal(t, wantDataTx, gotDataTx)
}

func Test_ConvertOperation(t *testing.T) {
	var lcm xdr.LedgerCloseMeta
	err := xdr.SafeUnmarshalBase64(ledgerCloseMetaXDR, &lcm)
	require.NoError(t, err)

	ledgerTxReader, err := ingest.NewLedgerTransactionReaderFromLedgerCloseMeta(network.TestNetworkPassphrase, lcm)
	require.NoError(t, err)
	ingestTx, err := ledgerTxReader.Read()
	require.NoError(t, err)

	opIndex := 0
	op := ingestTx.Envelope.Operations()[opIndex]
	opID := toid.New(int32(ingestTx.Ledger.LedgerSequence()), int32(ingestTx.Index), int32(opIndex+1)).ToInt64()

	gotDataOp, err := ConvertOperation(&ingestTx, &op, opID)
	require.NoError(t, err)

	wantDataOp := &types.Operation{
		ID:              opID,
		OperationType:   types.OperationTypeFromXDR(op.Body.Type),
		OperationXDR:    opXDRStr,
		LedgerCreatedAt: time.Date(2025, time.June, 19, 0, 3, 16, 0, time.UTC),
		LedgerNumber:    4873,
		TxHash:          "64eb94acc50eefc323cea80387fdceefc31466cc3a69eb8d2b312e0b5c3c62f0",
	}
	assert.Equal(t, wantDataOp, gotDataOp)
}
